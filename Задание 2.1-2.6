#include <util/delay.h>

void setup() {
    Serial.begin(9600);
    
    // 2.1. Настройка DDRx
    DDRB = 0b00111000;  
    
    DDRD = 0b00000000; 
    PORTD = 0b00011100; 
    
    
}

void loop() {
    // 2.2. Чтение байта состояния входного порта
    uint8_t port_val = PIND;
    
    Serial.print("PIND: ");
    for (int i = 7; i >= 0; i--) {
        Serial.print((port_val >> i) & 1);
    }
    Serial.println();
    
    // 2.3. Определение нажатых кнопок
    uint8_t buttons_pressed = (~port_val) & 0b00011100;
    
    Serial.print("Нажатые кнопки (биты): ");
    bool anyPressed = false;
    for (uint8_t n = 0; n < 8; n++) {
        if (buttons_pressed & (1 << n)) {
            Serial.print(n);
            Serial.print(" ");
            anyPressed = true;
        }
    }
    if (!anyPressed) Serial.print("нет");
    Serial.println();
    
      // 2.4. Формирование байта с единицами в позициях нажатых кнопок
    uint8_t output_byte = buttons_pressed;
    
    // Способ 1: через маску и OR
    PORTB = (PORTB & 0b11000111) | (output_byte << 3);
    
    // Способ 2: через bitSet/bitClear (побитово)
    for (uint8_t n = 0; n < 8; n++) {
        if (buttons_pressed & (1 << n)) {
            if (n == 2) bitClear(PORTB, 5); // Красный при нажатии PD2
            if (n == 3) bitSet(PORTB, 4); // Желтый при нажатии PD3
            if (n == 4) bitSet(PORTB, 3); // Зеленый при нажатии PD4
        } else {
            if (n == 2) bitSet(PORTB, 5);  // Выключить красный
            if (n == 3) bitClear(PORTB, 4); // Выключить желтый
            if (n == 4) bitClear(PORTB, 3); // Выключить зеленый
        }
    }
    
    Serial.print("Output byte: ");
    Serial.println(buttons_pressed, BIN);
    
    // 2.5. Поиск первого установленного бита
    uint8_t first_bit_loop = 255;
    for (uint8_t n = 0; n < 8; n++) {
        if (buttons_pressed & (1 << n)) {
            first_bit_loop = n;
            break;
        }
    }
    
    uint8_t first_bit_builtin = 255;
    if (buttons_pressed != 0) {
        first_bit_builtin = __builtin_ctz((unsigned int)buttons_pressed);
    }
    
    Serial.print("Первый бит (цикл): ");
    Serial.println(first_bit_loop);
    Serial.print("Первый бит (builtin): ");
    Serial.println(first_bit_builtin);
    Serial.println("-------------------");
    
    delay(200);
}
